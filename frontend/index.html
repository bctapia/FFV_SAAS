<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Molecule Drawer (Ketcher Standalone)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 12px; }
    #status { margin: 8px 0 16px; color: #555; }
    #ketcherFrame { width: 800px; height: 600px; border: 1px solid #ddd; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    textarea { min-height: 180px; }
    .row { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    button { padding: 8px 12px; border: 0; border-radius: 999px; font-weight: 600; cursor: pointer; background: #1766b5; color: #fff; }
    .ok { color: #146c2e; } .err { color: #b42318; }
  </style>
</head>
<body>
  <h1>Molecule Drawer (Ketcher Standalone)</h1>
  <div id="status">Loading…</div>

  <!-- iframe loads the standalone app you unzipped into ./ketcher-standalone/ -->
  <iframe id="ketcherFrame" src="./ketcher-standalone/index.html"></iframe>

  <div class="row" style="margin-top:8px">
    <button type="button" id="clearBtn">Clear</button>
  </div>

  <div class="grid">
    <div class="card">
      <label for="smiles">SMILES</label>
      <input id="smiles" type="text" readonly />
      <div class="row">
        <button type="button" id="copySmilesBtn">Copy SMILES</button>
      </div>
    </div>
    <div class="card">
      <label for="mol">Molfile (V2000)</label>
      <textarea id="mol" readonly></textarea>
      <div class="row">
        <button type="button" id="copyMolBtn">Copy Molfile</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <strong>Submit to backend</strong>
    <p>Posts <code>{ smiles, mol }</code> as JSON to <code>http://127.0.0.1:8001/api/analyze</code>.</p>
    <div class="row">
      <button type="button" id="submitBtn">Submit</button>
      <span id="submitStatus" aria-live="polite"></span>
    </div>
  </div>

  <script>
    const frame = document.getElementById('ketcherFrame');
    const statusEl = document.getElementById('status');
    const smilesEl = document.getElementById('smiles');
    const molEl = document.getElementById('mol');
    const submitStatusEl = document.getElementById('submitStatus');

    function K() {
      return frame.contentWindow.ketcher;
    }

    function waitForKetcher() {
      const id = setInterval(() => {
        if (frame.contentWindow && frame.contentWindow.ketcher) {
          clearInterval(id);
          init();
        }
      }, 200);
    }

    async function updateOutputs() {
      try {
        const smiles = await K().getSmiles();
        const mol = await K().getMolfile('v2000');
        smilesEl.value = smiles || "";
        molEl.value = mol || "";
      } catch (e) { console.error(e); }
    }

    async function init() {
      statusEl.textContent = "Editor loaded!";
      await updateOutputs();
      K().subscribe('change', updateOutputs);

      document.getElementById('clearBtn').onclick = async () => {
        await K().setMolecule('');
        await updateOutputs();
      };
      document.getElementById('copySmilesBtn').onclick = () => navigator.clipboard.writeText(smilesEl.value);
      document.getElementById('copyMolBtn').onclick = () => navigator.clipboard.writeText(molEl.value);
      document.getElementById('submitBtn').onclick = submitMolecule;
    }

    async function submitMolecule() {
      const smiles = smilesEl.value.trim();
      const mol = molEl.value.trim();
      submitStatusEl.textContent = "Submitting…"; submitStatusEl.className = "";
      try {
        const res = await fetch("http://127.0.0.1:8001/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ smiles, mol })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        await res.json();
        submitStatusEl.textContent = "Submitted ✔"; submitStatusEl.className = "ok";
      } catch (err) {
        console.error(err);
        submitStatusEl.textContent = "Submit failed"; submitStatusEl.className = "err";
      }
    }

    frame.addEventListener('load', waitForKetcher);
  </script>
</body>
</html>
